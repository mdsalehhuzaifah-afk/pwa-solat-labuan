<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Waktu Solat Labuan</title>
<style>
:root{--accent:#F1C40F;--radius:14px}
*{box-sizing:border-box}
body{margin:0;padding:16px;font-family:system-ui,Segoe UI,Roboto;background:#f4f6fa;color:#081124;display:flex;justify-content:center}
.dark{background:#071024;color:#e6eef8}
.app{max-width:520px;width:100%;background:#fff;border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.dark .app{background:#081122}
.header{display:flex;align-items:center;gap:12px}
.logo{width:60px;height:60px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#b8860b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:26px}
.controls{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap;justify-content:center}
.btn{padding:10px 14px;border-radius:12px;border:none;background:var(--accent);font-weight:700;cursor:pointer;color:#000}
.btn.ghost{background:#eef2f7;color:#333}
.card{margin-top:14px;background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
.dark .card{background:#081122}
.item{display:flex;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee}
.item:last-child{border-bottom:none}
.prayer{font-weight:800;color:var(--accent)}
.countdown{margin-top:12px;padding:12px;border-radius:12px;background:#fff;display:flex;justify-content:space-between}
.dark .countdown{background:#081122}
.timer{font-size:20px;font-weight:900}
.footer{margin-top:14px;font-size:12px;color:#64748b;text-align:center}
#qiblaBox{display:none;padding:14px;text-align:center}
#manualBox{display:none;margin-top:10px;padding:10px;background:#f8f9fa;border-radius:8px}
#permBtn{display:none;margin:10px auto;background:#e74c3c;color:white}
#notifBtn{background:#27ae60;color:white}

/* HAMBURGER & PANEL */
.menuBtn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:10px;
  border:none;
  background:#eef2f7;
  cursor:pointer;
}
.menuIcon{
  width:18px;height:14px;display:inline-block;position:relative;
}
.menuIcon span{position:absolute;height:2px;background:#333;width:100%;left:0;transition:all .25s}
.menuIcon span:nth-child(1){top:0}
.menuIcon span:nth-child(2){top:6px}
.menuIcon span:nth-child(3){top:12px}

/* panel that contains prayer checkboxes */
.prayerPanel{
  display:none;
  margin:10px auto 0;
  width:100%;
  background:#fff;
  border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.06);
  padding:12px;
}
/* grid layout - 3 columns (3 baris maks 2 atau 3 per row depending) */
.prayerGrid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  align-items:center;
  justify-items:center;
}
.prayerGrid label{
  display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;background:#f2f6fa;width:100%;justify-content:center;cursor:pointer;
  user-select:none;
}
.prayerGrid input{transform:scale(1.2);margin-right:6px}
.prayerGrid span{font-weight:700;color:#0b6b4f}

/* small helper for mobile spacing */
@media (max-width:420px){
  .prayerGrid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="logo">Ù…</div>
    <div>
      <h2>Waktu Solat Labuan</h2>
      <small id="hijri">Memuatkan...</small>
    </div>
  </div>

  <div class="controls">
    <button class="btn ghost" id="btnQibla">Kiblat</button>
    <button class="btn" id="refresh">Refresh</button>
    <button class="btn ghost" id="darkBtn">Dark</button>

    <!-- HAMBURGER: tekan untuk tunjuk panel pilihan solat -->
    <button class="menuBtn" id="menuBtn" aria-expanded="false" aria-controls="prayerPanel" title="Pilih solat untuk notifikasi">
      <div class="menuIcon" aria-hidden="true">
        <span></span><span></span><span></span>
      </div>
      <div>Notifikasi Pilih</div>
    </button>

    <button class="btn" id="notifBtn">ðŸ”” Notifikasi</button>
    <button class="btn ghost" id="notifToggle">OFF</button>
  </div>

  <!-- PANEL (TERSEMBUNYI) -->
  <div id="prayerPanel" class="prayerPanel" role="region" aria-label="Pilihan solat">
    <div style="text-align:center;margin-bottom:8px;font-size:13px;color:#555">Pilih waktu solat untuk notifikasi</div>
    <div class="prayerGrid" id="prayerSelect">
      <label><input type="checkbox" value="fajr"><span>Subuh</span></label>
      <label><input type="checkbox" value="dhuhr"><span>Zohor</span></label>
      <label><input type="checkbox" value="asr"><span>Asar</span></label>
      <label><input type="checkbox" value="maghrib"><span>Maghrib</span></label>
      <label><input type="checkbox" value="isha"><span>Isyak</span></label>
    </div>
  </div>

  <div id="zone" style="text-align:center;font-weight:bold">Menentukan lokasiâ€¦</div>
  <div id="date" style="text-align:center;color:#666"></div>

  <div class="card" id="list">
    <div style="padding:20px;text-align:center">Sila tunggu...</div>
  </div>

  <div class="countdown" id="countdown" style="display:none">
    <div>
      <div id="nextName"></div>
      <small id="nextTime"></small>
    </div>
    <div class="timer" id="timer">00:00:00</div>
  </div>

  <audio id="azan" preload="auto">
    <source src="https://www.muslimcentral.com/wp-content/uploads/adhan.mp3" type="audio/mpeg">
  </audio>

  <!-- KIBLAT -->
  <div id="qiblaBox" class="card">
    <h3>ðŸ§­ Arah Kiblat</h3>
    <button id="permBtn" class="btn">Benarkan Kompas</button>
    <div id="qiblaAngle" style="font-weight:800">â€”</div>
    <svg width="200" height="200" viewBox="0 0 100 100" style="margin:10px 0">
      <circle cx="50" cy="50" r="46" fill="none" stroke="#ddd" stroke-width="2" />
      <text x="50" y="10" text-anchor="middle" font-size="5" fill="#999">N</text>
      <text x="90" y="52" text-anchor="middle" font-size="5" fill="#999">E</text>
      <text x="50" y="94" text-anchor="middle" font-size="5" fill="#999">S</text>
      <text x="10" y="52" text-anchor="middle" font-size="5" fill="#999">W</text>
      <circle cx="50" cy="50" r="3" fill="#333" />
      <line id="qiblaArrow" x1="50" y1="50" x2="50" y2="10" stroke="#F1C40F" stroke-width="5" stroke-linecap="round" />
      <text x="50" y="20" text-anchor="middle" font-size="4" fill="#555" font-weight="bold">KAABAH</text>
    </svg>
    <div class="controls">
      <button class="btn ghost" id="btnManual">Manual</button>
    </div>
    <div id="manualBox">
      <small>Letakkan phone di atas lantai rata. Pusingkan phone sehingga kompas 0Â° (Utara), kemudian cari darjah di bawah:</small>
      <div id="manualDegree" style="font-weight:900;font-size:20px;color:#F1C40F;margin-top:5px">â€”Â°</div>
    </div>
  </div>

  <div class="footer">PWA â€“ Labuan (WLY02)</div>
</div>

<script>
/* ===== CONFIG ===== */
const ZONE = 'WLY02';
const API = 'https://api.waktusolat.app/v2/solat/';
const ORDER = ['fajr','syuruk','dhuhr','asr','maghrib','isha'];
const NAME = {fajr:'Subuh',syuruk:'Syuruk',dhuhr:'Zohor',asr:'Asar',maghrib:'Maghrib',isha:'Isyak'};
let today=null, nextTs=null, nextKey=null, timerInt=null;

/* ===== QIBLA VARS ===== */
const KAABA_LAT = 21.422487, KAABA_LON = 39.826206;
let qiblaBearing = 0;

/* ===== NOTIFICATION STATE ===== */
let notifEnabled = localStorage.getItem("notif")==="on";
let notifTimeout = null;
let selectedPrayers = JSON.parse(localStorage.getItem("prayers")) || ["fajr","dhuhr","asr","maghrib","isha"];

/* ===== INIT & EVENTS ===== */
init();
document.getElementById('refresh').onclick = init;
document.getElementById('darkBtn').onclick = () => document.body.classList.toggle('dark');

document.getElementById('btnQibla').onclick = toggleQibla;
document.getElementById('btnManual').onclick = () => {
  const el = document.getElementById('manualBox');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
};
document.getElementById('permBtn').onclick = requestSensorPermission;

/* hamburger menu toggle */
const menuBtn = document.getElementById('menuBtn');
const prayerPanel = document.getElementById('prayerPanel');
menuBtn.onclick = (e) => {
  const open = prayerPanel.style.display === 'block';
  prayerPanel.style.display = open ? 'none' : 'block';
  menuBtn.setAttribute('aria-expanded', String(!open));
};

/* notif buttons */
document.getElementById('notifBtn').onclick = () => {
  if(!('Notification' in window)){ alert("Browser tak sokong notifikasi"); return; }
  Notification.requestPermission().then(p => {
    if(p === 'granted'){
      notifEnabled = true;
      localStorage.setItem('notif','on');
      updateToggleUI();
      // schedule immediately if there's a next prayer suitable
      if(nextTs && selectedPrayers.includes(nextKey)) {
        scheduleNotification();
        scheduleAzanExact();
      }
      alert('Notifikasi dihidupkan âœ…');
    }
  }).catch(()=>{});
};

document.getElementById('notifToggle').onclick = () => {
  notifEnabled = !notifEnabled;
  localStorage.setItem('notif', notifEnabled ? 'on' : 'off');
  updateToggleUI();
  if(!notifEnabled) clearTimeout(notifTimeout);
};

function updateToggleUI(){
  const t = document.getElementById('notifToggle');
  t.innerText = notifEnabled ? 'ON' : 'OFF';
  t.style.background = notifEnabled ? '#27ae60' : '#ccc';
  t.style.color = notifEnabled ? '#fff' : '#000';
}

/* restore prayer checkboxes and wire them */
document.querySelectorAll("#prayerSelect input").forEach(cb => {
  cb.checked = selectedPrayers.includes(cb.value);
  cb.onchange = () => {
    selectedPrayers = [...document.querySelectorAll("#prayerSelect input:checked")].map(i => i.value);
    localStorage.setItem('prayers', JSON.stringify(selectedPrayers));
    // if user toggles selection and there's an upcoming prayer, reschedule
    if(nextTs) {
      clearTimeout(notifTimeout);
      if(notifEnabled && selectedPrayers.includes(nextKey)){
        scheduleNotification();
        scheduleAzanExact();
      }
    }
  };
});

updateToggleUI();

/* ===== FUNCTIONS: FETCH & RENDER ===== */
function init(){
  fetch(API + ZONE)
    .then(r => r.json())
    .then(d => {
      const now = new Date();
      today = d.prayers.find(p => {
        const pDate = new Date(p.fajr * 1000);
        return pDate.getDate() === now.getDate() &&
               pDate.getMonth() === now.getMonth() &&
               pDate.getFullYear() === now.getFullYear();
      });

      if(!today){
        document.getElementById('zone').innerText = 'Data hari ini tiada';
        return;
      }

      document.getElementById('zone').innerText = 'Zon: ' + d.zone;
      document.getElementById('date').innerText = now.toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      renderList();
      setupCountdown();
      renderHijri();
      // start qibla location (so manual degree gets shown)
      startLocation();
    })
    .catch((err) => {
      console.error(err);
      document.getElementById('zone').innerText = 'Gagal sambung server';
    });
}

function renderList(){
  const list = document.getElementById('list');
  list.innerHTML = '';
  ORDER.forEach(k => {
    const t = new Date(today[k]*1000).toLocaleTimeString('ms-MY', {hour:'2-digit', minute:'2-digit'});
    list.innerHTML += `<div class="item"><div class="prayer">${NAME[k]}</div><div>${t}</div></div>`;
  });
}

function setupCountdown(){
  clearInterval(timerInt);
  const now = Date.now();
  nextTs = null;
  for(const k of ORDER){
    if(today[k]*1000 > now){
      nextKey = k;
      nextTs = today[k]*1000;
      break;
    }
  }
  if(!nextTs){ document.getElementById('countdown').style.display = 'none'; return; }

  document.getElementById('countdown').style.display = 'flex';
  document.getElementById('nextName').innerText = NAME[nextKey];
  document.getElementById('nextTime').innerText = new Date(nextTs).toLocaleTimeString('ms-MY', {hour:'2-digit', minute:'2-digit'});

  // schedule only if notif enabled and this prayer selected
  if(notifEnabled && selectedPrayers.includes(nextKey)){
    scheduleNotification();
    scheduleAzanExact();
  }

  timerInt = setInterval(() => {
    const r = nextTs - Date.now();
    if(r <= 0){
      document.getElementById('azan').play().catch(()=>{});
      clearInterval(timerInt);
      init();
      return;
    }
    document.getElementById('timer').innerText = format(r);
  }, 1000);
}

function format(ms){
  const s = Math.floor(ms/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

/* ===== QIBLAT ENGINE (ASAL) ===== */
function toggleQibla(){
  const box = document.getElementById('qiblaBox');
  box.style.display = box.style.display === 'none' ? 'block' : 'none';
  if(box.style.display === 'block') startLocation();
}

function startLocation(){
  if(!navigator.geolocation) { return; }

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    qiblaBearing = calcQibla(lat, lon);

    document.getElementById('qiblaAngle').innerText = `Arah Kiblat: ${qiblaBearing.toFixed(1)}Â°`;
    document.getElementById('manualDegree').innerText = `${qiblaBearing.toFixed(1)}Â°`;

    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      document.getElementById('permBtn').style.display = 'block';
    } else {
      window.addEventListener('deviceorientationabsolute', handleOrientation, true);
      window.addEventListener('deviceorientation', handleOrientation, true);
    }
  }, () => {/* ignore gps denied gracefully */});
}

function requestSensorPermission() {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(response => {
        if (response === 'granted') {
          document.getElementById('permBtn').style.display = 'none';
          window.addEventListener('deviceorientation', handleOrientation, true);
        } else {
          alert('Izin ditolak. Kompas tidak dapat berfungsi.');
        }
      })
      .catch(console.error);
  }
}

function handleOrientation(e) {
  let compass = e.webkitCompassHeading || Math.abs(e.alpha - 360);
  if(compass) {
     const rotate = qiblaBearing - compass;
     document.getElementById('qiblaArrow').setAttribute('transform', `rotate(${rotate} 50 50)`);
  }
}

function calcQibla(lat, lon){
  const Ï†1 = lat * Math.PI/180, Ï†2 = KAABA_LAT * Math.PI/180;
  const d = (KAABA_LON - lon) * Math.PI/180;
  const y = Math.sin(d);
  const x = Math.cos(Ï†1) * Math.tan(Ï†2) - Math.sin(Ï†1) * Math.cos(d);
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

/* ===== HIJRI ===== */
async function renderHijri(){
  try{
    const d = new Date();
    const q = `${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;
    const r = await fetch(`https://api.aladhan.com/v1/gToH?date=${q}`);
    const j = await r.json();
    document.getElementById('hijri').innerText = j.data.hijri.date;
  }catch(e){}
}

/* ===== NOTIFICATION + VIBRATE (UPGRADED) ===== */
function scheduleNotification(){
  clearTimeout(notifTimeout);
  if(!nextTs) return;
  const t = nextTs - (5 * 60 * 1000) - Date.now();
  if(t <= 0) return;
  notifTimeout = setTimeout(() => {
    try{ navigator.vibrate?.([200,100,200]); }catch(e){}
    new Notification("Waktu Solat Hampir", {
      body: `${NAME[nextKey]} 5 minit lagi`,
      icon: ""
    });
  }, t);
}

function scheduleAzanExact(){
  if(!nextTs) return;
  const t = nextTs - Date.now();
  if(t <= 0) return;
  setTimeout(() => {
    try{ navigator.vibrate?.([300,150,300]); }catch(e){}
    new Notification("ðŸ•Œ Masuk Waktu Solat", {
      body: `Sekarang masuk waktu ${NAME[nextKey]}`,
      icon: ""
    });
  }, t);
}
</script>
</body>
</html>
