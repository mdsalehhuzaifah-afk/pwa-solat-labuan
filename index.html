<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Waktu Solat Labuan</title>

<style>
:root{--accent:#F1C40F;--radius:14px}
*{box-sizing:border-box}
body{margin:0;padding:16px;font-family:system-ui,Segoe UI,Roboto;background:#f4f6fa;color:#081124;display:flex;justify-content:center}
.dark{background:#071024;color:#e6eef8}
.app{max-width:520px;width:100%;background:#fff;border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.dark .app{background:#081122}

.header{display:flex;align-items:center;gap:12px}
.logo{width:60px;height:60px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#b8860b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:26px}

.controls{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap;justify-content:center}
.btn{padding:10px 14px;border-radius:12px;border:none;background:var(--accent);font-weight:700;cursor:pointer;color:#000}
.btn.ghost{background:#eef2f7;color:#333}

.card{margin-top:14px;background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
.dark .card{background:#081122}

.item{display:flex;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee}
.item:last-child{border-bottom:none}
.prayer{font-weight:800;color:var(--accent)}

.countdown{margin-top:12px;padding:12px;border-radius:12px;background:#fff;display:flex;justify-content:space-between}
.dark .countdown{background:#081122}
.timer{font-size:20px;font-weight:900}

.footer{margin-top:14px;font-size:12px;color:#64748b;text-align:center}

#qiblaBox{display:none;padding:14px;text-align:center}
#manualBox{display:none;margin-top:10px;padding:10px;background:#f8f9fa;border-radius:8px}
#permBtn{display:none;margin:10px auto;background:#e74c3c;color:white}

/* NOTIFICATION BUTTON */
#notifBtn{border-radius:12px;padding:10px 14px;border:none;cursor:pointer}
#notifBtn.off{background:#d1d5db;color:#111}
#notifBtn.on{background:#27ae60;color:#fff}

/* MENU */
.menuBtn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:none;background:#eef2f7;cursor:pointer}
.menuIcon{width:18px;height:14px;position:relative}
.menuIcon span{position:absolute;height:2px;background:#333;width:100%;left:0}
.menuIcon span:nth-child(1){top:0}
.menuIcon span:nth-child(2){top:6px}
.menuIcon span:nth-child(3){top:12px}

.prayerPanel{display:none;margin:10px auto 0;background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:12px}
.prayerGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.prayerGrid label{display:flex;align-items:center;gap:6px;padding:8px;border-radius:10px;background:#f2f6fa;font-weight:700;justify-content:center}
@media(max-width:420px){.prayerGrid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>

<body>
<div class="app">

<div class="header">
  <div class="logo">Ù…</div>
  <div>
    <h2>Waktu Solat Labuan</h2>
    <small id="hijri">Memuatkanâ€¦</small>
  </div>
</div>

<div class="controls">
  <button class="btn ghost" id="btnQibla">Kiblat</button>
  <button class="btn" id="refresh">Refresh</button>
  <button class="btn ghost" id="darkBtn">Dark</button>

  <button class="menuBtn" id="menuBtn">
    <div class="menuIcon"><span></span><span></span><span></span></div>
    Notifikasi Pilih
  </button>

  <button id="notifBtn" class="off">ðŸ”” Notifikasi (OFF)</button>
</div>

<div id="prayerPanel" class="prayerPanel">
  <div style="text-align:center;font-size:13px;margin-bottom:6px">Pilih solat untuk notifikasi</div>
  <div class="prayerGrid" id="prayerSelect">
    <label><input type="checkbox" value="fajr"> Subuh</label>
    <label><input type="checkbox" value="dhuhr"> Zohor</label>
    <label><input type="checkbox" value="asr"> Asar</label>
    <label><input type="checkbox" value="maghrib"> Maghrib</label>
    <label><input type="checkbox" value="isha"> Isyak</label>
  </div>
</div>

<div id="zone" style="text-align:center;font-weight:bold">Memuatkanâ€¦</div>
<div id="date" style="text-align:center;color:#666"></div>

<div class="card" id="list"></div>

<div class="countdown" id="countdown" style="display:none">
  <div>
    <div id="nextName"></div>
    <small id="nextTime"></small>
  </div>
  <div class="timer" id="timer">00:00:00</div>
</div>

<audio id="azan" preload="auto">
  <source src="https://www.muslimcentral.com/wp-content/uploads/adhan.mp3" type="audio/mpeg">
</audio>

<!-- KIBLAT -->
<div id="qiblaBox" class="card">
<h3>ðŸ§­ Arah Kiblat</h3>
<button id="permBtn" class="btn">Benarkan Kompas</button>
<div id="qiblaAngle">â€”</div>
<svg width="200" height="200" viewBox="0 0 100 100">
<circle cx="50" cy="50" r="46" fill="none" stroke="#ddd" stroke-width="2"/>
<line id="qiblaArrow" x1="50" y1="50" x2="50" y2="10" stroke="#F1C40F" stroke-width="5"/>
</svg>
<button class="btn ghost" id="btnManual">Manual</button>
<div id="manualBox">Arah: <b id="manualDegree">â€”Â°</b></div>
</div>

<div class="footer">PWA â€“ Labuan (WLY02)</div>
</div>

<script>
/* ===== CONFIG ===== */
const ZONE='WLY02';
const API='https://api.waktusolat.app/v2/solat/';
const ORDER=['fajr','syuruk','dhuhr','asr','maghrib','isha'];
const NAME={fajr:'Subuh',syuruk:'Syuruk',dhuhr:'Zohor',asr:'Asar',maghrib:'Maghrib',isha:'Isyak'};

let today=null,nextTs=null,nextKey=null,timerInt=null;

/* NOTIFICATION STATE */
let notifEnabled=localStorage.getItem("notif")==="on";
let notifTimeout=null;
let azanTimeout=null;
let azanPoll=null;
let azanFired=false;

let selectedPrayers=JSON.parse(localStorage.getItem("prayers"))||["fajr","dhuhr","asr","maghrib","isha"];

/* INIT */
init();
document.getElementById('refresh').onclick=init;
document.getElementById('darkBtn').onclick=()=>document.body.classList.toggle('dark');
document.getElementById('btnQibla').onclick=()=>toggle('qiblaBox');
document.getElementById('btnManual').onclick=()=>toggle('manualBox');

document.getElementById('menuBtn').onclick=()=>toggle('prayerPanel');

/* NOTIF BUTTON */
const notifBtn=document.getElementById('notifBtn');
notifBtn.onclick=toggleNotif;

function updateNotifUI(){
  notifBtn.className=notifEnabled?'on':'off';
  notifBtn.innerText=`ðŸ”” Notifikasi (${notifEnabled?'ON':'OFF'})`;
}
updateNotifUI();

/* PRAYER CHECKBOX */
document.querySelectorAll("#prayerSelect input").forEach(cb=>{
  cb.checked=selectedPrayers.includes(cb.value);
  cb.onchange=()=>{
    selectedPrayers=[...document.querySelectorAll("#prayerSelect input:checked")].map(i=>i.value);
    localStorage.setItem("prayers",JSON.stringify(selectedPrayers));
  }
});

/* ===== FUNCTIONS ===== */
function toggle(id){
  const el=document.getElementById(id);
  el.style.display=el.style.display==='block'?'none':'block';
}

function toggleNotif(){
  if(!('Notification'in window)){alert("Browser tak sokong notifikasi");return;}
  if(notifEnabled){
    notifEnabled=false;
    localStorage.setItem("notif","off");
    clearAllNotif();
    updateNotifUI();
    return;
  }
  Notification.requestPermission().then(p=>{
    if(p==='granted'){
      notifEnabled=true;
      localStorage.setItem("notif","on");
      updateNotifUI();
      setupCountdown();
    }
  });
}

function clearAllNotif(){
  clearTimeout(notifTimeout);
  clearTimeout(azanTimeout);
  clearInterval(azanPoll);
  azanFired=false;
}

function init(){
fetch(API+ZONE).then(r=>r.json()).then(d=>{
  today=d.prayers[0];
  document.getElementById('zone').innerText='Zon: '+d.zone;
  document.getElementById('date').innerText=new Date().toLocaleDateString('ms-MY',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  renderList();
  setupCountdown();
  renderHijri();
});
}

function renderList(){
  const list=document.getElementById('list');
  list.innerHTML='';
  ORDER.forEach(k=>{
    const t=new Date(today[k]*1000).toLocaleTimeString('ms-MY',{hour:'2-digit',minute:'2-digit'});
    list.innerHTML+=`<div class="item"><div class="prayer">${NAME[k]}</div><div>${t}</div></div>`;
  });
}

function setupCountdown(){
  clearInterval(timerInt);
  clearAllNotif();

  const now=Date.now();
  for(const k of ORDER){
    if(today[k]*1000>now){nextKey=k;nextTs=today[k]*1000;break;}
  }
  if(!nextTs)return;

  document.getElementById('countdown').style.display='flex';
  document.getElementById('nextName').innerText=NAME[nextKey];
  document.getElementById('nextTime').innerText=new Date(nextTs).toLocaleTimeString('ms-MY',{hour:'2-digit',minute:'2-digit'});

  if(notifEnabled && selectedPrayers.includes(nextKey)){
    scheduleBefore();
    scheduleExact();
  }

  timerInt=setInterval(()=>{
    const r=nextTs-Date.now();
    if(r<=0){init();return;}
    document.getElementById('timer').innerText=format(r);
  },1000);
}

function format(ms){
  const s=Math.floor(ms/1000);
  return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor(s%3600/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}

/* ===== NOTIFICATION ENGINE ===== */
function scheduleBefore(){
  notifTimeout=setTimeout(()=>{
    navigator.vibrate?.([200,100,200]);
    new Notification("Waktu Solat Hampir",{body:`${NAME[nextKey]} 5 minit lagi`});
  },nextTs-Date.now()-300000);
}

function fireAzan(){
  if(azanFired)return;
  azanFired=true;
  navigator.vibrate?.([300,150,300]);
  new Notification("ðŸ•Œ Masuk Waktu Solat",{body:`Sekarang ${NAME[nextKey]}`});
  document.getElementById('azan').play().catch(()=>{});
}

function scheduleExact(){
  const t=nextTs-Date.now();
  azanTimeout=setTimeout(fireAzan,t);

  setTimeout(()=>{
    azanPoll=setInterval(()=>{
      if(Date.now()>=nextTs){
        clearInterval(azanPoll);
        fireAzan();
      }
    },1000);
  },Math.max(0,t-30000));
}

/* ===== HIJRI ===== */
async function renderHijri(){
  try{
    const d=new Date();
    const r=await fetch(`https://api.aladhan.com/v1/gToH?date=${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`);
    const j=await r.json();
    document.getElementById('hijri').innerText=j.data.hijri.date;
  }catch(e){}
}
</script>
</body>
</html>
