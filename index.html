<!doctype html>

<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Waktu Solat Labuan</title>
<link rel="manifest" href="manifest.json">
<style>
:root{--accent:#F1C40F;--radius:14px}
*{box-sizing:border-box}
body{margin:0;padding:16px;font-family:system-ui,Segoe UI,Roboto;background:#f4f6fa;color:#081124;display:flex;justify-content:center}
.dark{background:#071024;color:#e6eef8}
.app{max-width:520px;width:100%;background:#fff;border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.dark .app{background:#081122}
.header{display:flex;align-items:center;gap:12px}
.logo{width:60px;height:60px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#b8860b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:26px}
.controls{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap;justify-content:center}
.btn{padding:10px 14px;border-radius:12px;border:none;background:var(--accent);font-weight:700;cursor:pointer}
.btn.ghost{background:#eef2f7}
.card{margin-top:14px;background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
.dark .card{background:#081122}
.item{display:flex;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee}
.item:last-child{border-bottom:none}
.prayer{font-weight:800;color:var(--accent)}
.countdown{margin-top:12px;padding:12px;border-radius:12px;background:#fff;display:flex;justify-content:space-between}
.dark .countdown{background:#081122}
.timer{font-size:20px;font-weight:900}
.footer{margin-top:14px;font-size:12px;color:#64748b;text-align:center}
#qiblaBox{display:none;padding:14px;text-align:center}
#manualBox,#mapBox{display:none;margin-top:10px}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">Ù…</div>
    <div>
      <h2>Waktu Solat Labuan</h2>
      <small id="hijri">â€”</small>
    </div>
  </div>  <div class="controls">
    <button class="btn ghost" id="btnQibla">Kiblat</button>
    <button class="btn" id="refresh">Refresh</button>
    <button class="btn ghost" id="darkBtn">Dark</button>
  </div>  <div id="zone">Menentukan lokasiâ€¦</div>
  <div id="date"></div>
  <div class="card" id="list"></div>  <div class="countdown" id="countdown" style="display:none">
    <div>
      <div id="nextName"></div>
      <small id="nextTime"></small>
    </div>
    <div class="timer" id="timer">00:00:00</div>
  </div>  <audio id="azan" preload="auto">
    <source src="https://www.muslimcentral.com/wp-content/uploads/adhan.mp3" type="audio/mpeg">
  </audio>  <div id="qiblaBox" class="card">
    <h3>ðŸ§­ Arah Kiblat</h3>
    <div id="qiblaAngle" style="font-weight:800;font-size:18px;margin-bottom:6px">â€”</div><svg width="200" height="200" viewBox="0 0 100 100" style="margin:10px 0">
  <circle cx="50" cy="50" r="46" fill="none" stroke="#ddd" stroke-width="4" />
  <circle cx="50" cy="50" r="3" fill="#999" />
  <line id="qiblaArrow" x1="50" y1="50" x2="50" y2="8" stroke="#F1C40F" stroke-width="5" stroke-linecap="round" />
  <text x="50" y="14" text-anchor="middle" font-size="6" fill="#555">KAABAH</text>
</svg>

<div class="controls">
  <button class="btn ghost" id="btnManual">Manual</button>
  <button class="btn ghost" id="btnMap">Map</button>
</div>

<div id="manualBox">
  <small>Hadap ke arah:</small>
  <div id="manualDegree" style="font-weight:900;font-size:20px">â€”Â°</div>
</div>

<div id="mapBox">
  <iframe id="qiblaMap" width="100%" height="220" style="border:0;border-radius:12px" loading="lazy"></iframe>
</div>

  </div>  <div class="footer">PWA â€“ Labuan (WLY02)</div>
</div><script>
/* ===== CONFIG (FIXED) ===== */
const ZONE = 'WLY02';
const API = 'https://api.waktusolat.app/v2/solat/';
const ORDER = ['fajr','syuruk','dhuhr','asr','maghrib','isha'];
const NAME = {fajr:'Subuh',syuruk:'Syuruk',dhuhr:'Zohor',asr:'Asar',maghrib:'Maghrib',isha:'Isyak'};
let today=null, nextTs=null, nextKey=null, timerInt=null;

init();

document.getElementById('refresh').onclick=init;
document.getElementById('darkBtn').onclick=()=>document.body.classList.toggle('dark');
document.getElementById('btnQibla').onclick=toggleQibla;
document.getElementById('btnMap').onclick=()=>toggleDisplay('mapBox');
document.getElementById('btnManual').onclick=()=>toggleDisplay('manualBox');

function init(){
  fetch(API + ZONE)
    .then(r=>r.json())
    .then(d=>{
      today = d.prayers; // FIXED
      document.getElementById('zone').innerText = 'Zon: ' + d.zone;
      document.getElementById('date').innerText = new Date().toLocaleDateString('ms-MY');
      renderList();
      setupCountdown();
      renderHijri();
    })
    .catch(()=>{
      document.getElementById('zone').innerText='Gagal ambil data waktu solat';
    });
}

function renderList(){
  const list=document.getElementById('list');
  list.innerHTML='';
  ORDER.forEach(k=>{
    const t=new Date(today[k]*1000).toLocaleTimeString('ms-MY',{hour:'2-digit',minute:'2-digit'});
    list.innerHTML+=`<div class="item"><div class="prayer">${NAME[k]}</div><div>${t}</div></div>`;
  });
}

function setupCountdown(){
  clearInterval(timerInt);
  const now=Date.now();
  for(const k of ORDER){
    if(today[k]*1000>now){nextKey=k;nextTs=today[k]*1000;break;}
  }
  document.getElementById('countdown').style.display='flex';
  document.getElementById('nextName').innerText=NAME[nextKey];
  document.getElementById('nextTime').innerText=new Date(nextTs).toLocaleTimeString('ms-MY');

  timerInt=setInterval(()=>{
    const r=nextTs-Date.now();
    if(r<=0){document.getElementById('azan').play().catch(()=>{});clearInterval(timerInt);return;}
    document.getElementById('timer').innerText=format(r);
  },1000);
}

function format(ms){
  const s=Math.floor(ms/1000);
  return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor(s%3600/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}

/* ===== QIBLAT ===== */
const KAABA_LAT=21.4225, KAABA_LON=39.8262;
function toggleQibla(){
  const box=document.getElementById('qiblaBox');
  box.style.display=box.style.display==='none'?'block':'none';
  if(box.style.display==='block') startQibla();
}

function startQibla(){
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    const b=calcQibla(lat,lon);
    document.getElementById('qiblaAngle').innerText=`Arah Kiblat: ${b.toFixed(1)}Â°`;
    document.getElementById('manualDegree').innerText=`${b.toFixed(1)}Â°`;
    document.getElementById('qiblaMap').src=`https://www.google.com/maps?q=${lat},${lon}&z=3&output=embed`;
    if(window.DeviceOrientationEvent){
      window.addEventListener('deviceorientation',e=>{
        if(e.alpha==null) return;
        document.getElementById('qiblaArrow').setAttribute('transform',`rotate(${b-e.alpha} 50 50)`);
      });
    }
  });
}

function calcQibla(lat,lon){
  const Ï†1=lat*Math.PI/180, Ï†2=KAABA_LAT*Math.PI/180;
  const d=(KAABA_LON-lon)*Math.PI/180;
  const y=Math.sin(d);
  const x=Math.cos(Ï†1)*Math.tan(Ï†2)-Math.sin(Ï†1)*Math.cos(d);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

async function renderHijri(){
  try{
    const d=new Date();
    const q=`${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;
    const r=await fetch(`https://api.aladhan.com/v1/gToH?date=${q}`);
    const j=await r.json();
    document.getElementById('hijri').innerText='Hijri: '+j.data.hijri.date;
  }catch{}
}

function toggleDisplay(id){
  const el=document.getElementById(id);
  el.style.display=el.style.display==='none'?'block':'none';
}
</script></body>
      </html>
