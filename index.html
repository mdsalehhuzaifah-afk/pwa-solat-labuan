<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Waktu Solat Labuan</title>
<link rel="manifest" href="manifest.json">
<style>
:root{
  --accent:#F1C40F;
  --radius:18px;
  --bg-light:#f4f6fa;
  --bg-dark:#071024;
  --card-light:#fff;
  --card-dark:#081122;
  --text-light:#081124;
  --text-dark:#e6eef8;
  --shadow:0 10px 30px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Roboto,Poppins,sans-serif;transition:all 0.3s}
body{
  background:var(--bg-light);
  color:var(--text-light);
  display:flex;
  justify-content:center;
  padding:16px;
}
.dark{background:var(--bg-dark);color:var(--text-dark)}
.app{
  max-width:520px;
  width:100%;
  background:var(--card-light);
  border-radius:var(--radius);
  padding:20px;
  box-shadow:var(--shadow);
}
.dark .app{background:var(--card-dark)}
.header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
.logo{
  width:60px;height:60px;
  border-radius:var(--radius);
  background:linear-gradient(135deg,var(--accent),#b8860b);
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:900;font-size:28px;
  box-shadow:0 4px 10px rgba(0,0,0,.2);
}
.header h2{font-size:22px;margin-bottom:4px;}
.header small{color:#888;}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:16px}
.btn{
  padding:10px 16px;border-radius:12px;border:none;
  background:var(--accent);color:#fff;
  font-weight:700;cursor:pointer;
  box-shadow:0 4px 8px rgba(0,0,0,.1);
  transition:transform 0.2s, box-shadow 0.2s;
}
.btn:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,.15);}
.btn.ghost{background:#eef2f7;color:#081124;}
.dark .btn.ghost{background:#081122;color:#e6eef8;}
.card{
  background:var(--card-light);
  border-radius:var(--radius);
  box-shadow:0 4px 16px rgba(0,0,0,.05);
  margin-top:14px;
  padding:12px;
}
.dark .card{background:var(--card-dark)}
.item{
  display:flex;justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid #eee;
}
.dark .item{border-color:#222}
.item:last-child{border-bottom:none}
.prayer{font-weight:800;color:var(--accent)}
.countdown{
  margin-top:14px;
  padding:16px;
  border-radius:var(--radius);
  background:var(--card-light);
  display:flex;justify-content:space-between;
  align-items:center;
  font-family:monospace;
  font-size:20px;
}
.dark .countdown{background:var(--card-dark)}
.timer{font-size:28px;font-weight:900;color:var(--accent)}
#qiblaBox{display:none;padding:16px;text-align:center;margin-top:14px}
#manualBox,#mapBox{display:none;margin-top:12px}
#qiblaArrow{transition:transform 0.3s ease;}
.footer{text-align:center;font-size:12px;color:#64748b;margin-top:16px}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">Ù…</div>
    <div>
      <h2>Waktu Solat Labuan</h2>
      <small id="hijri">â€”</small>
    </div>
  </div>

  <div class="controls">
    <button class="btn ghost" id="btnQibla">Kiblat</button>
    <button class="btn" id="refresh">Refresh</button>
    <button class="btn ghost" id="darkBtn">Dark</button>
  </div>

  <div id="zone">Menentukan lokasiâ€¦</div>
  <div id="date" style="margin-top:6px;font-weight:600;"></div>
  <div class="card" id="list"></div>

  <div class="countdown" id="countdown" style="display:none">
    <div>
      <div id="nextName" style="font-size:20px;font-weight:700"></div>
      <small id="nextTime"></small>
    </div>
    <div class="timer" id="timer">00:00:00</div>
  </div>

  <audio id="azan" preload="auto">
    <source src="https://www.muslimcentral.com/wp-content/uploads/adhan.mp3" type="audio/mpeg">
  </audio>

  <div id="qiblaBox" class="card">
    <h3 style="margin-bottom:10px">ðŸ§­ Arah Kiblat</h3>
    <div id="qiblaAngle" style="font-weight:800;font-size:18px;margin-bottom:8px">â€”</div>

    <svg width="200" height="200" viewBox="0 0 100 100" style="margin:12px 0">
      <circle cx="50" cy="50" r="46" fill="none" stroke="#ddd" stroke-width="4" />
      <circle cx="50" cy="50" r="3" fill="#999" />
      <line id="qiblaArrow" x1="50" y1="50" x2="50" y2="8" stroke="var(--accent)" stroke-width="5" stroke-linecap="round" />
      <text x="50" y="14" text-anchor="middle" font-size="6" fill="#555">KAABAH</text>
    </svg>

    <div class="controls">
      <button class="btn ghost" id="btnCalibrate">Kalibrasi</button>
      <button class="btn ghost" id="btnFullscreen">Full Screen</button>
      <button class="btn ghost" id="btnManual">Manual</button>
      <button class="btn ghost" id="btnMap">Map</button>
      <button class="btn ghost" id="btnMasjid">Mode Masjid</button>
    </div>

    <div id="manualBox">
      <small>Hadap ke arah:</small>
      <div id="manualDegree" style="font-weight:900;font-size:20px">â€”Â°</div>
      <small>(guna kompas fizikal jika sensor tiada)</small>
    </div>

    <div id="mapBox">
      <iframe id="qiblaMap" width="100%" height="220" style="border:0;border-radius:12px" loading="lazy"></iframe>
    </div>

    <small style="display:block;margin-top:10px;color:#64748b">
      Ketepatan bergantung pada sensor kompas telefon<br>
      Gerakkan telefon dalam bentuk âˆž untuk kalibrasi
    </small>
  </div>

  <div class="footer">PWA â€“ Labuan (WLY02)</div>
</div>

<script>
// ========== CONFIG ==========
const ZONE='WLY02';
const API='https://api.waktusolat.app/v2/solat/zone/';
const ORDER=['fajr','syuruk','dhuhr','asr','maghrib','isha'];
const NAME={fajr:'Subuh',syuruk:'Syuruk',dhuhr:'Zohor',asr:'Asar',maghrib:'Maghrib',isha:'Isyak'};
let today=null,nextTs=null,nextKey=null,timerInt=null;

// ========== INIT ==========
init();
document.getElementById('refresh').onclick=init;
document.getElementById('darkBtn').onclick=()=>document.body.classList.toggle('dark');
document.getElementById('btnQibla').onclick=toggleQibla;
document.getElementById('btnCalibrate').onclick=()=>alert('Gerakkan telefon dalam bentuk âˆž');
document.getElementById('btnMap').onclick=()=>toggleDisplay('mapBox');
document.getElementById('btnMasjid').onclick=()=>document.body.classList.toggle('masjid');
document.getElementById('btnManual').onclick=()=>toggleDisplay('manualBox');
document.getElementById('btnFullscreen').onclick=()=>document.getElementById('qiblaBox').requestFullscreen?.();

// ========== FUNCTIONS ==========
function init(){
  fetch(API+ZONE).then(r=>r.json()).then(d=>{
    today=d.prayers[0];
    document.getElementById('zone').innerText='Zon: '+d.zone;
    document.getElementById('date').innerText=today.day;
    renderList();
    setupCountdown();
    renderHijri();
  });
}

function renderList(){
  const list=document.getElementById('list'); list.innerHTML='';
  ORDER.forEach(k=>{
    const t=new Date(today[k]*1000).toLocaleTimeString('ms-MY',{hour:'2-digit',minute:'2-digit'});
    list.innerHTML+=`<div class="item"><div class="prayer">${NAME[k]}</div><div>${t}</div></div>`;
  });
}

function setupCountdown(){
  clearInterval(timerInt);
  const now=Date.now();
  for(const k of ORDER){if(today[k]*1000>now){nextKey=k;nextTs=today[k]*1000;break;}}
  document.getElementById('countdown').style.display='flex';
  document.getElementById('nextName').innerText=NAME[nextKey];
  document.getElementById('nextTime').innerText=new Date(nextTs).toLocaleTimeString('ms-MY');

  timerInt=setInterval(()=>{
    const r=nextTs-Date.now();
    if(r<=0){playAzan();clearInterval(timerInt);return;}
    document.getElementById('timer').innerText=format(r);
  },1000);
}

function format(ms){
  const s=Math.floor(ms/1000);
  return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor(s%3600/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}

function playAzan(){document.getElementById('azan').play().catch(()=>{});}

// ========== QIBLAT ==========
const KAABA_LAT=21.4225, KAABA_LON=39.8262;

function toggleQibla(){
  const box=document.getElementById('qiblaBox');
  box.style.display=box.style.display==='none'?'block':'none';
  if(box.style.display==='block') startQibla();
}

function startQibla(){
  if(!navigator.geolocation){ alert('GPS tidak disokong'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    const bearing=calcQibla(lat,lon);
    document.getElementById('qiblaAngle').innerText=`Arah Kiblat: ${bearing.toFixed(1)}Â°`;
    document.getElementById('manualDegree').innerText=`${bearing.toFixed(1)}Â°`;
    document.getElementById('qiblaMap').src=`https://www.google.com/maps?q=${lat},${lon}&z=3&output=embed`;
    if(window.DeviceOrientationEvent){
      window.addEventListener('deviceorientation',e=>{
        const heading=e.alpha; if(heading===null) return;
        const rot=bearing-heading;
        document.getElementById('qiblaArrow').setAttribute('transform',`rotate(${rot} 50 50)`);
      });
    }
  },()=>alert('Sila benarkan GPS untuk cari kiblat'));
}

function calcQibla(lat,lon){
  const Ï†1=lat*Math.PI/180, Ï†2=KAABA_LAT*Math.PI/180, Î”Î»=(KAABA_LON-lon)*Math.PI/180;
  const y=Math.sin(Î”Î»), x=Math.cos(Ï†1)*Math.tan(Ï†2)-Math.sin(Ï†1)*Math.cos(Î”Î»);
  let Î¸=Math.atan2(y,x)*180/Math.PI;
  return (Î¸+360)%360;
}

async function renderHijri(){
  try{
    const d=new Date();
    const q=`${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;
    const r=await fetch(`https://api.aladhan.com/v1/gToH?date=${q}`);
    const j=await r.json();
    document.getElementById('hijri').innerText='Hijri: '+j.data.hijri.date;
  }catch{}
}

function toggleDisplay(id){
  const el=document.getElementById(id);
  el.style.display=el.style.display==='none'?'block':'none';
}
</script>
</body>
</html>