<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Waktu Solat Labuan</title>
<style>
:root{--accent:#F1C40F;--radius:14px}
*{box-sizing:border-box}
body{margin:0;padding:16px;font-family:system-ui,Segoe UI,Roboto;background:#f4f6fa;color:#081124;display:flex;justify-content:center}
.dark{background:#071024;color:#e6eef8}
.app{max-width:520px;width:100%;background:#fff;border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.dark .app{background:#081122}
.header{display:flex;align-items:center;gap:12px}
.logo{width:60px;height:60px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#b8860b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:26px}
.controls{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap;justify-content:center}
.btn{padding:10px 14px;border-radius:12px;border:none;background:var(--accent);font-weight:700;cursor:pointer;color:#000}
.btn.ghost{background:#eef2f7;color:#333}
.card{margin-top:14px;background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
.dark .card{background:#081122}
.item{display:flex;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee}
.item:last-child{border-bottom:none}
.prayer{font-weight:800;color:var(--accent)}
.countdown{margin-top:12px;padding:12px;border-radius:12px;background:#fff;display:flex;justify-content:space-between}
.dark .countdown{background:#081122}
.timer{font-size:20px;font-weight:900}
.footer{margin-top:14px;font-size:12px;color:#64748b;text-align:center}

#qiblaBox{display:none;padding:14px;text-align:center}
#manualBox{display:none;margin-top:10px;padding:10px;background:#f8f9fa;border-radius:8px}
#permBtn{display:none;margin:10px auto;background:#e74c3c;color:white}
#notifBtn{background:#27ae60;color:white}

/* pilih solat */
.selectBox{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:10px 0}
.selectBox label{background:#eef2f7;padding:6px 10px;border-radius:10px;font-size:13px;cursor:pointer}
.selectBox input:checked+span{background:#27ae60;color:#fff;padding:6px 10px;border-radius:10px}
</style>
</head>

<body>
<div class="app">

<div class="header">
  <div class="logo">Ù…</div>
  <div>
    <h2>Waktu Solat Labuan</h2>
    <small id="hijri">Memuatkan...</small>
  </div>
</div>

<div class="controls">
  <button class="btn ghost" id="btnQibla">Kiblat</button>
  <button class="btn" id="refresh">Refresh</button>
  <button class="btn ghost" id="darkBtn">Dark</button>
  <button class="btn" id="notifBtn">ðŸ”” Notifikasi</button>
  <button class="btn ghost" id="notifToggle">OFF</button>
</div>

<div class="selectBox" id="prayerSelect">
  <label><input type="checkbox" value="fajr"><span>Subuh</span></label>
  <label><input type="checkbox" value="dhuhr"><span>Zohor</span></label>
  <label><input type="checkbox" value="asr"><span>Asar</span></label>
  <label><input type="checkbox" value="maghrib"><span>Maghrib</span></label>
  <label><input type="checkbox" value="isha"><span>Isyak</span></label>
</div>

<div id="zone" style="text-align:center;font-weight:bold">Menentukan lokasiâ€¦</div>
<div id="date" style="text-align:center;color:#666"></div>

<div class="card" id="list">
  <div style="padding:20px;text-align:center">Sila tunggu...</div>
</div>

<div class="countdown" id="countdown" style="display:none">
  <div>
    <div id="nextName"></div>
    <small id="nextTime"></small>
  </div>
  <div class="timer" id="timer">00:00:00</div>
</div>

<audio id="azan" preload="auto">
  <source src="https://www.muslimcentral.com/wp-content/uploads/adhan.mp3" type="audio/mpeg">
</audio>

<!-- KIBLAT -->
<div id="qiblaBox" class="card">
<h3>ðŸ§­ Arah Kiblat</h3>
<button id="permBtn" class="btn">Benarkan Kompas</button>
<div id="qiblaAngle" style="font-weight:800">â€”</div>
<svg width="200" height="200" viewBox="0 0 100 100">
  <circle cx="50" cy="50" r="46" fill="none" stroke="#ddd" stroke-width="2"/>
  <line id="qiblaArrow" x1="50" y1="50" x2="50" y2="10" stroke="#F1C40F" stroke-width="5"/>
</svg>
<button class="btn ghost" id="btnManual">Manual</button>
<div id="manualBox">
  <small>Arah darjah kiblat:</small>
  <div id="manualDegree" style="font-weight:900;color:#F1C40F">â€”Â°</div>
</div>
</div>

<div class="footer">PWA â€“ Labuan (WLY02)</div>
</div>

<script>
/* ===== CONFIG ===== */
const ZONE='WLY02';
const API='https://api.waktusolat.app/v2/solat/';
const ORDER=['fajr','syuruk','dhuhr','asr','maghrib','isha'];
const NAME={fajr:'Subuh',syuruk:'Syuruk',dhuhr:'Zohor',asr:'Asar',maghrib:'Maghrib',isha:'Isyak'};
let today,nextTs,nextKey,timerInt;

/* ===== INIT ===== */
init();
refresh.onclick=init;
darkBtn.onclick=()=>document.body.classList.toggle('dark');
btnQibla.onclick=()=>qiblaBox.style.display=qiblaBox.style.display==='none'?'block':'none';
btnManual.onclick=()=>manualBox.style.display=manualBox.style.display==='none'?'block':'none';

/* ===== FETCH ===== */
function init(){
fetch(API+ZONE).then(r=>r.json()).then(d=>{
const now=new Date();
today=d.prayers.find(p=>new Date(p.fajr*1000).getDate()===now.getDate());
zone.innerText='Zon: '+d.zone;
date.innerText=now.toLocaleDateString('ms-MY',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
renderList();setupCountdown();renderHijri();startLocation();
});
}

function renderList(){
list.innerHTML='';
ORDER.forEach(k=>{
const t=new Date(today[k]*1000).toLocaleTimeString('ms-MY',{hour:'2-digit',minute:'2-digit'});
list.innerHTML+=`<div class="item"><div class="prayer">${NAME[k]}</div><div>${t}</div></div>`;
});
}

function setupCountdown(){
clearInterval(timerInt);
const now=Date.now();
for(const k of ORDER){if(today[k]*1000>now){nextKey=k;nextTs=today[k]*1000;break;}}
if(!nextTs)return;

countdown.style.display='flex';
nextName.innerText=NAME[nextKey];
nextTime.innerText=new Date(nextTs).toLocaleTimeString('ms-MY',{hour:'2-digit',minute:'2-digit'});

if(notifEnabled && selectedPrayers.includes(nextKey)){
 scheduleNotification();
 scheduleAzanExact();
}

timerInt=setInterval(()=>{
const r=nextTs-Date.now();
if(r<=0){azan.play().catch(()=>{});init();return;}
timer.innerText=format(r);
},1000);
}

function format(ms){
const s=Math.floor(ms/1000);
return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor(s%3600/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}

/* ===== HIJRI ===== */
async function renderHijri(){
try{
const d=new Date();
const r=await fetch(`https://api.aladhan.com/v1/gToH?date=${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`);
const j=await r.json();
hijri.innerText=j.data.hijri.date;
}catch(e){}
}

/* ===== KIBLAT ===== */
const KAABA_LAT=21.422487,KAABA_LON=39.826206;
let qiblaBearing=0;

function startLocation(){
if(!navigator.geolocation)return;
navigator.geolocation.getCurrentPosition(pos=>{
const lat=pos.coords.latitude,lon=pos.coords.longitude;
qiblaBearing=calcQibla(lat,lon);
qiblaAngle.innerText=`Arah Kiblat: ${qiblaBearing.toFixed(1)}Â°`;
manualDegree.innerText=`${qiblaBearing.toFixed(1)}Â°`;

if(DeviceOrientationEvent?.requestPermission){
 permBtn.style.display='block';
 permBtn.onclick=()=>{
  DeviceOrientationEvent.requestPermission().then(p=>{
   if(p==='granted')window.addEventListener('deviceorientation',handleOrientation,true);
  });
 };
}else{
 window.addEventListener('deviceorientationabsolute',handleOrientation,true);
}
});
}

function handleOrientation(e){
const compass=e.webkitCompassHeading||Math.abs(e.alpha-360);
if(compass){
 const rotate=qiblaBearing-compass;
 qiblaArrow.setAttribute('transform',`rotate(${rotate} 50 50)`);
}
}

function calcQibla(lat,lon){
const Ï†1=lat*Math.PI/180,Ï†2=KAABA_LAT*Math.PI/180;
const d=(KAABA_LON-lon)*Math.PI/180;
const y=Math.sin(d);
const x=Math.cos(Ï†1)*Math.tan(Ï†2)-Math.sin(Ï†1)*Math.cos(d);
return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* ===== NOTIFICATION UPGRADE ===== */
let notifEnabled=localStorage.getItem("notif")==="on";
let notifTimeout=null;
let selectedPrayers=JSON.parse(localStorage.getItem("prayers"))||["fajr","dhuhr","asr","maghrib","isha"];

document.querySelectorAll("#prayerSelect input").forEach(cb=>{
 cb.checked=selectedPrayers.includes(cb.value);
 cb.onchange=()=>{
  selectedPrayers=[...document.querySelectorAll("#prayerSelect input:checked")].map(i=>i.value);
  localStorage.setItem("prayers",JSON.stringify(selectedPrayers));
 };
});

notifBtn.onclick=()=>{
Notification.requestPermission().then(p=>{
 if(p==="granted"){
  notifEnabled=true;
  localStorage.setItem("notif","on");
  updateToggle();
 }
});
};

notifToggle.onclick=()=>{
notifEnabled=!notifEnabled;
localStorage.setItem("notif",notifEnabled?"on":"off");
updateToggle();
};

function updateToggle(){
notifToggle.innerText=notifEnabled?"ON":"OFF";
notifToggle.style.background=notifEnabled?"#27ae60":"#ccc";
}

function scheduleNotification(){
clearTimeout(notifTimeout);
const t=nextTs-(5*60*1000)-Date.now();
if(t<=0)return;
notifTimeout=setTimeout(()=>{
 navigator.vibrate?.([200,100,200]);
 new Notification("Waktu Solat Hampir",{body:`${NAME[nextKey]} 5 minit lagi`});
},t);
}

function scheduleAzanExact(){
const t=nextTs-Date.now();
if(t<=0)return;
setTimeout(()=>{
 navigator.vibrate?.([300,150,300]);
 new Notification("ðŸ•Œ Masuk Waktu Solat",{body:`Sekarang masuk waktu ${NAME[nextKey]}`});
},t);
}
</script>
</body>
</html>
