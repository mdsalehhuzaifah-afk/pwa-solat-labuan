<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Waktu Solat Labuan</title>
<style>
:root{--accent:#F1C40F}
*{box-sizing:border-box}
body{margin:0;padding:16px;font-family:system-ui,Segoe UI,Roboto;background:#f4f6fa;color:#081124;display:flex;justify-content:center}
.dark{background:#071024;color:#e6eef8}
.app{max-width:520px;width:100%;background:#fff;border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
.header{display:flex;align-items:center;gap:12px}
.logo{width:60px;height:60px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#b8860b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:26px}
.controls{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap;justify-content:center}
.btn{padding:10px 14px;border-radius:12px;border:none;background:var(--accent);font-weight:700;cursor:pointer;color:#000}
.btn.ghost{background:#eef2f7;color:#333}
.card{margin-top:14px;background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
.item{display:flex;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee}
.prayer{font-weight:800;color:var(--accent)}
.countdown{margin-top:12px;padding:12px;border-radius:12px;background:#fff;display:flex;justify-content:space-between;align-items:center}
.timer{font-size:20px;font-weight:900}
.footer{margin-top:14px;font-size:12px;color:#64748b;text-align:center}
#qiblaBox{display:none;padding:14px;text-align:center}
#manualBox{display:none;margin-top:10px;padding:10px;background:#f8f9fa;border-radius:8px}
#permBtn{display:none;margin:10px auto;background:#e74c3c;color:white}

/* notif button states */
#notifBtn{border-radius:12px;padding:10px 14px;border:none;cursor:pointer}
#notifBtn.off{background:#d1d5db;color:#111}
#notifBtn.on{background:#27ae60;color:#fff}

/* hamburger & panel */
.menuBtn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:none;background:#eef2f7;cursor:pointer}
.menuIcon{width:18px;height:14px;position:relative}
.menuIcon span{position:absolute;height:2px;background:#333;width:100%;left:0}
.menuIcon span:nth-child(1){top:0}
.menuIcon span:nth-child(2){top:6px}
.menuIcon span:nth-child(3){top:12px}

.prayerPanel{display:none;margin:10px auto 0;background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:12px}
.prayerGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.prayerGrid label{display:flex;align-items:center;gap:6px;padding:8px;border-radius:10px;background:#f2f6fa;font-weight:700;justify-content:center}
@media(max-width:420px){.prayerGrid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">Ù…</div>
    <div>
      <h2>Waktu Solat Labuan</h2>
      <small id="hijri">Memuatkan...</small>
    </div>
  </div>

  <div class="controls">
    <button class="btn ghost" id="btnQibla">Kiblat</button>
    <button class="btn" id="refresh">Refresh</button>
    <button class="btn ghost" id="darkBtn">Dark</button>

    <button class="menuBtn" id="menuBtn" title="Pilih solat untuk notifikasi">
      <div class="menuIcon" aria-hidden="true"><span></span><span></span><span></span></div>
      <div>Notifikasi Pilih</div>
    </button>

    <button id="notifBtn" class="off">ðŸ”” Notifikasi (OFF)</button>
  </div>

  <div id="prayerPanel" class="prayerPanel" role="region" aria-label="Pilihan solat">
    <div style="text-align:center;margin-bottom:8px;font-size:13px;color:#555">Pilih waktu solat untuk notifikasi</div>
    <div class="prayerGrid" id="prayerSelect">
      <label><input type="checkbox" value="fajr"> Subuh</label>
      <label><input type="checkbox" value="dhuhr"> Zohor</label>
      <label><input type="checkbox" value="asr"> Asar</label>
      <label><input type="checkbox" value="maghrib"> Maghrib</label>
      <label><input type="checkbox" value="isha"> Isyak</label>
    </div>
  </div>

  <div id="zone" style="text-align:center;font-weight:bold">Menentukan lokasiâ€¦</div>
  <div id="date" style="text-align:center;color:#666"></div>

  <div class="card" id="list"><div style="padding:20px;text-align:center">Sila tunggu...</div></div>

  <div class="countdown" id="countdown" style="display:none">
    <div>
      <div id="nextName" style="font-weight:800"></div>
      <small id="nextTime" style="color:#666"></small>
    </div>
    <div class="timer" id="timer">00:00:00</div>
  </div>

  <audio id="azan" preload="auto">
    <source src="https://www.muslimcentral.com/wp-content/uploads/adhan.mp3" type="audio/mpeg" />
  </audio>

  <!-- Kiblat -->
  <div id="qiblaBox" class="card">
    <h3>ðŸ§­ Arah Kiblat</h3>
    <button id="permBtn" class="btn">Benarkan Kompas</button>
    <div id="qiblaAngle" style="font-weight:800">â€”</div>
    <svg width="200" height="200" viewBox="0 0 100 100" style="margin:10px 0">
      <circle cx="50" cy="50" r="46" fill="none" stroke="#ddd" stroke-width="2" />
      <line id="qiblaArrow" x1="50" y1="50" x2="50" y2="10" stroke="#F1C40F" stroke-width="5" />
    </svg>
    <div class="controls"><button class="btn ghost" id="btnManual">Manual</button></div>
    <div id="manualBox"><small>Letakkan phone di atas lantai rata... </small><div id="manualDegree" style="font-weight:900;font-size:20px;color:#F1C40F;margin-top:5px">â€”Â°</div></div>
  </div>

  <div class="footer">PWA â€“ Labuan (WLY02)</div>
</div>

<script>
/* ===== CONFIG ===== */
const ZONE = 'WLY02';
const API = 'https://api.waktusolat.app/v2/solat/';
const ORDER = ['fajr','syuruk','dhuhr','asr','maghrib','isha'];
const NAME = {fajr:'Subuh',syuruk:'Syuruk',dhuhr:'Zohor',asr:'Asar',maghrib:'Maghrib',isha:'Isyak'};

/* Qibla constants */
const KAABA_LAT = 21.422487, KAABA_LON = 39.826206;

/* State */
let today = null;
let nextTs = null;
let nextKey = null;
let timerInt = null;

/* Notification state */
let notifEnabled = localStorage.getItem('notif') === 'on';
let notifTimeout = null;
let azanTimeout = null;
let azanPoll = null;
let azanFired = false;
let selectedPrayers = JSON.parse(localStorage.getItem('prayers')) || ['fajr','dhuhr','asr','maghrib','isha'];

/* Init & events */
init();
document.getElementById('refresh').onclick = init;
document.getElementById('darkBtn').onclick = () => document.body.classList.toggle('dark');
document.getElementById('btnQibla').onclick = toggleQibla;
document.getElementById('btnManual').onclick = () => toggle('manualBox');
document.getElementById('menuBtn').onclick = () => toggle('prayerPanel');

const notifBtn = document.getElementById('notifBtn');
notifBtn.onclick = toggleNotif;
function updateNotifUI(){
  notifBtn.className = notifEnabled ? 'on' : 'off';
  notifBtn.innerText = `ðŸ”” Notifikasi (${notifEnabled ? 'ON' : 'OFF'})`;
}
updateNotifUI();

/* restore prayer checkboxes */
document.querySelectorAll('#prayerSelect input').forEach(cb=>{
  cb.checked = selectedPrayers.includes(cb.value);
  cb.onchange = () => {
    selectedPrayers = [...document.querySelectorAll('#prayerSelect input:checked')].map(i=>i.value);
    localStorage.setItem('prayers', JSON.stringify(selectedPrayers));
    // reschedule if needed
    if(nextTs){
      clearAllNotif();
      if(notifEnabled && selectedPrayers.includes(nextKey)){
        scheduleBefore(); scheduleExact();
      }
    }
  };
});

/* FUNCTIONS */
function toggle(id){
  const el = document.getElementById(id);
  el.style.display = el.style.display === 'block' ? 'none' : 'block';
}

function toggleNotif(){
  if(notifEnabled){
    notifEnabled = false;
    localStorage.setItem('notif','off');
    clearAllNotif();
    updateNotifUI();
    alert('Notifikasi dimatikan');
    return;
  }

  if(!('Notification' in window)){ alert('Browser tidak sokong notifikasi'); return; }

  if(Notification.permission === 'granted'){
    notifEnabled = true;
    localStorage.setItem('notif','on');
    updateNotifUI();
    if(nextTs && selectedPrayers.includes(nextKey)){ scheduleBefore(); scheduleExact(); }
    alert('Notifikasi dihidupkan');
    return;
  }

  if(Notification.permission === 'denied'){
    alert('Notifikasi telah disekat. Sila benarkan pada tetapan browser.');
    return;
  }

  Notification.requestPermission().then(p=>{
    if(p === 'granted'){
      notifEnabled = true;
      localStorage.setItem('notif','on');
      updateNotifUI();
      if(nextTs && selectedPrayers.includes(nextKey)){ scheduleBefore(); scheduleExact(); }
      alert('Notifikasi dihidupkan');
    } else {
      alert('Izin notifikasi tidak diberikan');
    }
  }).catch(()=>alert('Gagal meminta izin notifikasi'));
}

/* fetch & render */
async function init(){
  try{
    const r = await fetch(API + ZONE);
    const d = await r.json();
    const now = new Date();

    // find today's object
    today = d.prayers.find(p=>{
      const pDate = new Date(p.fajr * 1000);
      return pDate.getDate() === now.getDate() && pDate.getMonth() === now.getMonth() && pDate.getFullYear() === now.getFullYear();
    }) || d.prayers[0] || null;

    if(!today){ document.getElementById('zone').innerText = 'Data hari ini tiada'; return; }

    document.getElementById('zone').innerText = 'Zon: ' + d.zone;
    document.getElementById('date').innerText = now.toLocaleDateString('ms-MY', { weekday:'long', day:'numeric', month:'long', year:'numeric' });

    renderList();
    setupCountdown();
    renderHijri();
    startLocation();
  }catch(e){
    console.error(e);
    document.getElementById('zone').innerText = 'Gagal sambung server';
  }
}

function renderList(){
  const list = document.getElementById('list');
  list.innerHTML = '';
  ORDER.forEach(k=>{
    const t = today && today[k] ? new Date(today[k]*1000).toLocaleTimeString('ms-MY',{hour:'2-digit',minute:'2-digit'}) : '-';
    list.innerHTML += `<div class="item"><div class="prayer">${NAME[k]}</div><div>${t}</div></div>`;
  });
}

/* countdown + scheduling */
function setupCountdown(){
  clearInterval(timerInt);
  clearAllNotif();

  const now = Date.now();
  nextTs = null; nextKey = null;
  for(const k of ORDER){
    if(today && today[k] && (today[k]*1000) > now){
      nextKey = k; nextTs = today[k]*1000; break;
    }
  }

  if(!nextTs){
    document.getElementById('countdown').style.display = 'none';
    return;
  }

  document.getElementById('countdown').style.display = 'flex';
  document.getElementById('nextName').innerText = NAME[nextKey];
  document.getElementById('nextTime').innerText = new Date(nextTs).toLocaleTimeString('ms-MY',{hour:'2-digit',minute:'2-digit'});

  if(notifEnabled && selectedPrayers.includes(nextKey)){
    scheduleBefore(); scheduleExact();
  }

  timerInt = setInterval(()=>{
    const r = nextTs - Date.now();
    if(r <= 0){
      try{ document.getElementById('azan').play().catch(()=>{}); }catch(e){}
      clearInterval(timerInt);
      setTimeout(()=> init(), 500);
      return;
    }
    document.getElementById('timer').innerText = format(r);
  },1000);
}

function format(ms){
  const s = Math.floor(ms/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s % 3600)/60);
  const sec = s % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

/* QIBLA */
let qiblaBearing = 0;
function toggleQibla(){ toggle('qiblaBox'); if(document.getElementById('qiblaBox').style.display === 'block') startLocation(); }
function startLocation(){
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    qiblaBearing = calcQibla(lat, lon);
    document.getElementById('qiblaAngle').innerText = `Arah Kiblat: ${qiblaBearing.toFixed(1)}Â°`;
    document.getElementById('manualDegree').innerText = `${qiblaBearing.toFixed(1)}Â°`;
    if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
      document.getElementById('permBtn').style.display = 'block';
      document.getElementById('permBtn').onclick = requestSensorPermission;
    } else {
      window.addEventListener('deviceorientationabsolute', handleOrientation, true);
      window.addEventListener('deviceorientation', handleOrientation, true);
    }
  }, ()=>{/* ignore */});
}
function requestSensorPermission(){ if(typeof DeviceOrientationEvent.requestPermission === 'function'){ DeviceOrientationEvent.requestPermission().then(r=>{ if(r==='granted'){ document.getElementById('permBtn').style.display='none'; window.addEventListener('deviceorientation', handleOrientation, true);} else alert('Izin ditolak. Kompas tidak dapat berfungsi.'); }).catch(console.error); } }
function handleOrientation(e){ let compass = e.webkitCompassHeading || Math.abs(e.alpha - 360); if(compass){ const rotate = qiblaBearing - compass; document.getElementById('qiblaArrow').setAttribute('transform', `rotate(${rotate} 50 50)`); } }
function calcQibla(lat, lon){ const Ï†1=lat*Math.PI/180, Ï†2=KAABA_LAT*Math.PI/180; const d=(KAABA_LON-lon)*Math.PI/180; const y=Math.sin(d); const x=Math.cos(Ï†1)*Math.tan(Ï†2)-Math.sin(Ï†1)*Math.cos(d); return (Math.atan2(y,x)*180/Math.PI+360)%360; }

/* HIJRI */
async function renderHijri(){
  try{
    const d = new Date();
    const q = `${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;
    const r = await fetch(`https://api.aladhan.com/v1/gToH?date=${q}`);
    const j = await r.json();
    document.getElementById('hijri').innerText = j.data.hijri.date;
  }catch(e){}
}

/* Notification utilities */
function clearAllNotif(){
  if(notifTimeout){ clearTimeout(notifTimeout); notifTimeout = null; }
  if(azanTimeout){ clearTimeout(azanTimeout); azanTimeout = null; }
  if(azanPoll){ clearInterval(azanPoll); azanPoll = null; }
  azanFired = false;
}

/* schedule 5 min before (guarded) */
function scheduleBefore(){
  clearAllNotif();
  if(!nextTs) return;
  const ms = nextTs - Date.now() - (5*60*1000);
  if(ms <= 0) return;
  notifTimeout = setTimeout(()=>{
    if(Notification.permission !== 'granted'){ return; }
    if(!notifEnabled) return;
    if(!selectedPrayers.includes(nextKey)) return;
    try{ navigator.vibrate?.([200,100,200]); }catch(e){}
    try{ new Notification('Waktu Solat Hampir', { body: `${NAME[nextKey]} 5 minit lagi` }); }catch(e){ console.error(e); }
  }, ms);
}

/* fire azan notification & audio (guarded) */
function fireAzanNotification(){
  if(azanFired) return;
  azanFired = true;
  try{ navigator.vibrate?.([300,150,300]); }catch(e){}
  if(Notification.permission === 'granted' && notifEnabled && selectedPrayers.includes(nextKey)){
    try{ new Notification('ðŸ•Œ Masuk Waktu Solat', { body: `Sekarang masuk waktu ${NAME[nextKey]}` }); }catch(e){ console.error(e); }
  }
  try{ document.getElementById('azan').play().catch(()=>{}); }catch(e){}
}

/* schedule exact time with polling fallback */
function scheduleExact(){
  if(!nextTs) return;
  clearAllNotif();
  const t = nextTs - Date.now();
  if(t <= 0){ fireAzanNotification(); return; }

  azanTimeout = setTimeout(()=>{ fireAzanNotification(); if(azanPoll){ clearInterval(azanPoll); azanPoll=null; } azanTimeout=null; }, t);

  const POLL_BEFORE_MS = 30*1000;
  const pollStart = t - POLL_BEFORE_MS;
  if(pollStart > 0){
    setTimeout(()=>{
      if(azanPoll) clearInterval(azanPoll);
      azanPoll = setInterval(()=>{
        if(Date.now() >= nextTs){
          clearInterval(azanPoll); azanPoll=null;
          if(azanTimeout){ clearTimeout(azanTimeout); azanTimeout=null; }
          fireAzanNotification();
        }
      },1000);
    }, pollStart);
  } else {
    if(azanPoll) clearInterval(azanPoll);
    azanPoll = setInterval(()=>{
      if(Date.now() >= nextTs){
        clearInterval(azanPoll); azanPoll=null;
        if(azanTimeout){ clearTimeout(azanTimeout); azanTimeout=null; }
        fireAzanNotification();
      }
    },1000);
  }
}

/* ensure UI shows stored state */
updateNotifUI();
</script>
</body>
</html>
